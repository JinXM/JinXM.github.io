<!DOCTYPE html><html><head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <title>Alucard</title>
  <link rel="stylesheet" href="http://7xnm1u.com1.z0.glb.clouddn.com/js/cal-heatmap/cal-heatmap.css">
  <link rel="stylesheet" href="/css/style.css">
</head>
  <body>
    <div class="sidebar">
  <section class="sidebar-container">
    <header class="sidebar-header">
      <span class="img">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="http://7xnm1u.com1.z0.glb.clouddn.com/log/v1/logo-1to1-min.JPG" alt="">
      </span>
      <h1 class="title">
        <a href="http://jinxm.github.io/">Alucard</a>
      </h1>
      <p class="desc">
        <span>Earth, human, 90s</span>
        <br>
        <span><记录一些生活琐碎></span>
      </p>

      <div class="categories">
        <a href="/categories/daily">生活</a>
        <span>|</span>
        <a href="/categories/cs">技术</a>
      </div>
    </header>
  </section>
</div>
    <main class="main">
    <article class="post article-post">
  <div class="post-title">
    <h2 class="title">flv.js框架解读（1）</h2>
  </div>
   <div class="post-meta">
    <span class="post-time">2018-09-11</span>
    <span class="post-time author-info">Alucard</span>
  </div>
  <div class="post-content">
    <h4 id="知识储备"><a href="#知识储备" class="headerlink" title="知识储备"></a>知识储备</h4><p>流媒体方面的知识</p>
<ul>
<li>flv格式</li>
<li>mp4、fmp4格式</li>
</ul>
<p>前端方面的知识</p>
<ul>
<li>H5的video、audio标签</li>
<li>ES6</li>
<li>MSE</li>
</ul>
<h4 id="核心实现"><a href="#核心实现" class="headerlink" title="核心实现"></a>核心实现</h4><ul>
<li>video标签</li>
<li>MSE</li>
</ul>
<p>FLV（Flash Video）是 Adobe 推出的一种视频格式，既可以用flash 播放，又可以用其他非flash 播放器播放。</p>
<p>video标签是 H5的一个新媒体标签，即视频播放标签。但是video标签不支持直接播放flv 的视频。</p>
<p>MSE（Media Source Extensions），即流媒体扩展 API。 提供了实现无插件且基于 Web 的流媒体的功能。使用 MSE，媒体串流能够通过 JavaScript 创建，并且能通过使用 audio 和 video 元素进行播放。</p>
<p>所以flv.js核心做的事情是：<code>将获取到的flv 流媒体，经过格式转换，然后通过MSE 接口，喂给video标签</code>。</p>
<a id="more"></a>
<h4 id="基本框架"><a href="#基本框架" class="headerlink" title="基本框架"></a>基本框架</h4><p>主要分为4个模块：</p>
<ol>
<li>Data Loader：主要是负责从 API 接口获取流媒体数据；</li>
<li>DeMuxer：数据格式解码，将flv 格式解码；</li>
<li>ReMuxer：转码，将2的数据再转码成fmp4格式；</li>
<li>MSE Controller：利用 MSE 将fmp4数据标准化喂给video标签；</li>
</ol>
<p><a href="/image/2018/09-11/flv.js.jpg" data-fancybox="images" data-caption="flv.js 基本模块"><br>    <img class="cs-img img-vertical-lg" src="/image/2018/09-11/flv.js.jpg" alt="flv.js 基本模块"><br></a></p>
<h4 id="Data-Loader"><a href="#Data-Loader" class="headerlink" title="Data Loader"></a>Data Loader</h4><p>请求 API 获取flv 流媒体数据。response 里没有Content-Length，说明是一个持久的流媒体连接，Content-type 里说明返回的格式是二进制数据。</p>
<p>在Loader 里，数据的消费者，会每接收一定量字节的数据，然后进行消费操作；然后再接收(append)下一部分的数据。</p>
<h4 id="DeMuxer"><a href="#DeMuxer" class="headerlink" title="DeMuxer"></a>DeMuxer</h4><p>flv数据格式的解码。</p>
<p>flv 一种简单的格式，由Header 和 Body 组成。Body 是由length+tag 有规律的组成。</p>
<p>这里的解码，是将header 里一些有效信息和body 里的视频数据+时间戳提取出来，存在在 Pockets 中。</p>
<p>注意：会根据tag 中的类型标签，将音频数据和视频数据分别存放到APockets 和 VPockets中。</p>
<h4 id="ReMuxer"><a href="#ReMuxer" class="headerlink" title="ReMuxer"></a>ReMuxer</h4><p>这个模块主要是转码。</p>
<p>将 DeMuxer 后的Pockets 转码成fmp4。</p>
<p>fmp4 = fragment mp4<br>传统的mp4格式是以嵌套的模式进行存储的，索引信息再头部或者尾部一个巨大的box 里。所以需要加载完整个文件才能播放，还是以<code>文件</code>的模式。</p>
<p>而fmp4则是将索引信息的box 拆分成细微的minbox，每个 minibox 负责其后边跟随的数据box 的索引。所以fmp4可以边加载边播放，属于<code>流媒体</code>模式。</p>
<p>ReMuxer 将APockets 和 VPockets 转码成fmp4格式的AArrayBuffer 和 VArrayBuffer。</p>
<h4 id="MSE-Controller"><a href="#MSE-Controller" class="headerlink" title="MSE Controller"></a>MSE Controller</h4><p>MSE = Media Source Extensions<br>MSE 的对方和方法，可以用纯JavaScript 去调用将媒体流喂给video去播放。</p>
<p>MSE 提供了updateend 等监听方法，用于监听数据生产者(AArrayBuffer、VArrayBuffer)的变化。</p>
<p>再监听到之后，转换为Array Buffer，再将音视频合流成一个视频封装到 Media Source 对象中，最后由 Media Source 对象喂给video进行播放。</p>
<p>这里的音视频合流，MSE 里视频最多只允许1个，但是音频允许多个。在fllv.js 中，音频和视频都是1个。</p>
<p>参考资料：</p>
<ul>
<li><a href="https://wuyuans.com/2012/08/flv-format" target="_blank" rel="noopener">FLV文件格式解析 - Wuyuan’s Blog</a></li>
<li><a href="http://akagi201.org/post/websocket-mse/" target="_blank" rel="noopener">HTML5 直播协议之 WebSocket 和 MSE · Akagi201</a></li>
</ul>
<script>!function(o){var i=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function c(t,e){var n=new Image,o=t.getAttribute("data-original");n.onload=function(){t.src=o,e&&e()},n.src=o}function n(){for(var t=0;t<i.length;t++)e=i[t],void 0,0<=(n=e.getBoundingClientRect()).top&&0<=n.left&&n.top<=(o.innerHeight||document.documentElement.clientHeight)&&c(i[t],function(){i.splice(t,t)});var e,n;console.log("trigger")}n(),o.addEventListener("scroll",function(){var t,e;t=n,e=o,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script>
  </div>
</article>
    </main>
    -<script src="http://7xnm1u.com1.z0.glb.clouddn.com/js/jquery/jquery.min.js"></script>
-
-<!-- fancybox support -->
-
-    <link href="http://7xnm1u.com1.z0.glb.clouddn.com/js/fancybox-3.3.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css">
-    <script src="http://7xnm1u.com1.z0.glb.clouddn.com/js/fancybox-3.3.5/jquery.fancybox.min.js"></script>
-
-
-<script src="http://7xnm1u.com1.z0.glb.clouddn.com/js/d3/d3.min.js"></script>
-
-<script src="http://7xnm1u.com1.z0.glb.clouddn.com/js/cal-heatmap/cal-heatmap.min.js"></script>
-
-<script src="/js/script.js"></script>
-<script src="/js/photos.js"></script>
-<script src="/js/rg90d.js"></script>

  <script>!function(o){var i=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function c(t,e){var n=new Image,o=t.getAttribute("data-original");n.onload=function(){t.src=o,e&&e()},n.src=o}function n(){for(var t=0;t<i.length;t++)e=i[t],void 0,0<=(n=e.getBoundingClientRect()).top&&0<=n.left&&n.top<=(o.innerHeight||document.documentElement.clientHeight)&&c(i[t],function(){i.splice(t,t)});var e,n;console.log("trigger")}n(),o.addEventListener("scroll",function(){var t,e;t=n,e=o,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script>
<script type="text/javascript" charset="utf-8" src="/js/lazyload-plugin/lazyload.intersectionObserver.min.js"></script></body></html>